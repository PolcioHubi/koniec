<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administracyjny</title>
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Panel Administracyjny</h1>
            <a href="/admin/logout" class="logout-btn">Wyloguj</a>
        </div>

        <div id="alertContainer"></div>

        <div class="stats">
            <div class="stat-card">
                <h3 id="totalUsers">-</h3>
                <p>≈ÅƒÖczna liczba u≈ºytkownik√≥w</p>
            </div>
            <div class="stat-card">
                <h3 id="totalFiles">-</h3>
                <p>≈ÅƒÖczna liczba plik√≥w</p>
            </div>
            <div class="stat-card">
                <h3 id="totalSize">-</h3>
                <p>≈ÅƒÖczny rozmiar danych</p>
            </div>
        </div>

        <div class="users-section">
            <h2>ZarzƒÖdzanie u≈ºytkownikami</h2>
            <button class="refresh-btn" onclick="loadUsersData()">üîÑ Od≈õwie≈º dane</button>
            <input type="text" id="searchBox" class="search-box" placeholder="Szukaj u≈ºytkownik√≥w...">
            
            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>≈Åadowanie danych u≈ºytkownik√≥w...</p>
            </div>

            <table id="usersTable" class="users-table" style="display: none;">
                <thead>
                    <tr>
                        <th style="width: 20%;">Nazwa u≈ºytkownika</th>
                        <th style="width: 15%;">Data utworzenia</th>
                        <th style="width: 20%;">Ostatnia aktywno≈õƒá</th>
                        <th style="width: 10%;">Liczba plik√≥w</th>
                        <th style="width: 10%;">Rozmiar</th>
                        <th class="actions-column" style="width: 25%;">Akcje</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal do wy≈õwietlania log√≥w -->
    <div id="logsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLogsModal()">&times;</span>
            <h2 id="logsModalTitle">Logi u≈ºytkownika</h2>
            <div id="logsContent" class="log-content">≈Åadowanie log√≥w...</div>
        </div>
    </div>

    <script>
        let usersData = [];
        let isLoading = false;

        // Funkcje do zarzƒÖdzania alertami
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
            `;
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 8000);
        }

        // ≈Åadowanie danych u≈ºytkownik√≥w
        function loadUsersData() {
            if (isLoading) return;
            
            isLoading = true;
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('usersTable').style.display = 'none';
            
            fetch('/admin/api/users')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        usersData = data.users;
                        updateStats(data.stats);
                        displayUsers(usersData);
                        document.getElementById('loadingIndicator').style.display = 'none';
                        document.getElementById('usersTable').style.display = 'table';
                        showAlert(`Za≈Çadowano dane ${data.users.length} u≈ºytkownik√≥w`);
                    } else {
                        throw new Error(data.error || 'Nieznany b≈ÇƒÖd');
                    }
                })
                .catch(error => {
                    console.error('B≈ÇƒÖd:', error);
                    showAlert('WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania danych: ' + error.message, 'error');
                    document.getElementById('loadingIndicator').style.display = 'none';
                })
                .finally(() => {
                    isLoading = false;
                });
        }

        // Aktualizacja statystyk
        function updateStats(stats) {
            document.getElementById('totalUsers').textContent = stats.total_users;
            document.getElementById('totalFiles').textContent = stats.total_files;
            document.getElementById('totalSize').textContent = formatFileSize(stats.total_size);
        }

        // Formatowanie rozmiaru pliku
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Wy≈õwietlanie u≈ºytkownik√≥w w tabeli
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align: center; color: #666;">Brak u≈ºytkownik√≥w do wy≈õwietlenia</td>';
                tbody.appendChild(row);
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td title="${user.name}">${user.name}</td>
                    <td>${user.created_date}</td>
                    <td>${user.last_activity}</td>
                    <td>${user.file_count}</td>
                    <td>${formatFileSize(user.total_size)}</td>
                    <td class="actions-column">
                        <button class="action-btn download-btn" onclick="downloadUserFiles('${user.name}')" title="Pobierz pliki u≈ºytkownika">
                            üì• Pobierz
                        </button>
                        <button class="action-btn view-logs-btn" onclick="viewUserLogs('${user.name}')" title="Zobacz logi u≈ºytkownika">
                            üìã Logi
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteUser('${user.name}')" title="Usu≈Ñ u≈ºytkownika">
                            üóëÔ∏è Usu≈Ñ
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Wyszukiwanie u≈ºytkownik√≥w
        document.getElementById('searchBox').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const filteredUsers = usersData.filter(user => 
                user.name.toLowerCase().includes(searchTerm)
            );
            displayUsers(filteredUsers);
        });

        // Pobieranie plik√≥w u≈ºytkownika
        function downloadUserFiles(userName) {
            try {
                const link = document.createElement('a');
                link.href = `/admin/api/download-user/${encodeURIComponent(userName)}`;
                link.download = `${userName}_backup.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showAlert(`Rozpoczƒôto pobieranie plik√≥w u≈ºytkownika: ${userName}`);
            } catch (error) {
                console.error('B≈ÇƒÖd podczas pobierania:', error);
                showAlert('WystƒÖpi≈Ç b≈ÇƒÖd podczas pobierania plik√≥w', 'error');
            }
        }

        // Wy≈õwietlanie log√≥w u≈ºytkownika
        function viewUserLogs(userName) {
            document.getElementById('logsModalTitle').textContent = `Logi u≈ºytkownika: ${userName}`;
            document.getElementById('logsContent').innerHTML = '<div class="spinner"></div><p>≈Åadowanie log√≥w...</p>';
            document.getElementById('logsModal').style.display = 'block';

            fetch(`/admin/api/user-logs/${encodeURIComponent(userName)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        document.getElementById('logsContent').textContent = data.logs || 'Brak dostƒôpnych log√≥w';
                    } else {
                        throw new Error(data.error || 'Nieznany b≈ÇƒÖd');
                    }
                })
                .catch(error => {
                    console.error('B≈ÇƒÖd:', error);
                    document.getElementById('logsContent').textContent = 'B≈ÇƒÖd podczas ≈Çadowania log√≥w: ' + error.message;
                });
        }

        // Zamykanie modala z logami
        function closeLogsModal() {
            document.getElementById('logsModal').style.display = 'none';
        }

        // Usuwanie u≈ºytkownika
        function deleteUser(userName) {
            if (!confirm(`Czy na pewno chcesz usunƒÖƒá u≈ºytkownika "${userName}" i wszystkie jego dane?\n\nTa operacja jest NIEODWRACALNA!`)) {
                return;
            }

            // Dodatkowe potwierdzenie dla bezpiecze≈Ñstwa
            const confirmText = prompt(`Aby potwierdziƒá usuniƒôcie, wpisz nazwƒô u≈ºytkownika: "${userName}"`);
            if (confirmText !== userName) {
                showAlert('Usuwanie anulowane - nieprawid≈Çowa nazwa u≈ºytkownika', 'error');
                return;
            }

            fetch(`/admin/api/delete-user/${encodeURIComponent(userName)}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showAlert(`U≈ºytkownik "${userName}" zosta≈Ç pomy≈õlnie usuniƒôty`);
                    loadUsersData(); // Od≈õwie≈º listƒô
                } else {
                    throw new Error(data.error || 'Nieznany b≈ÇƒÖd');
                }
            })
            .catch(error => {
                console.error('B≈ÇƒÖd:', error);
                showAlert('WystƒÖpi≈Ç b≈ÇƒÖd podczas usuwania u≈ºytkownika: ' + error.message, 'error');
            });
        }

        // Zamykanie modala po klikniƒôciu poza nim
        window.onclick = function(event) {
            const modal = document.getElementById('logsModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Obs≈Çuga klawisza Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeLogsModal();
            }
        });

        // Inicjalizacja przy za≈Çadowaniu strony
        window.addEventListener('load', function() {
            loadUsersData();
        });

        // Auto-refresh co 30 sekund (opcjonalne)
        setInterval(function() {
            if (!isLoading && document.getElementById('usersTable').style.display !== 'none') {
                loadUsersData();
            }
        }, 30000);
    </script>
</body>
</html>

